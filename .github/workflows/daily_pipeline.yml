name: K2 Quiz Daily Pipeline

on:
  schedule:
    - cron: '30 6 * * *'    # 12:00 PM IST every day (6:30 AM UTC)
  workflow_dispatch:
    inputs:
      category:
        description: 'Category 1-13 (default 13 = Mixed GK)'
        required: false
        default: '13'
      dry_run:
        description: 'Skip YouTube upload (true/false)'
        required: false
        default: 'false'

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies (fonts + ffmpeg)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            fonts-noto \
            fonts-noto-extra \
            fonts-noto-color-emoji \
            ffmpeg \
            libraqm0

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Restore questions database (prevent repeats)
        uses: actions/cache@v4
        with:
          path: data/questions.db
          key: questions-db-v2-${{ github.run_number }}
          restore-keys: |
            questions-db-v2-

      - name: Write YouTube credentials from secrets
        env:
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_TOKEN: ${{ secrets.YOUTUBE_TOKEN }}
        run: |
          echo "$YOUTUBE_CLIENT_SECRET" > client_secret.json
          echo "$YOUTUBE_TOKEN" > youtube_token.json

      - name: Run daily pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: '1'
        run: |
          CATEGORY="${{ github.event.inputs.category || '13' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          if [ "$DRY_RUN" = "true" ]; then
            python daily_pipeline.py --category "$CATEGORY" --dry-run
          else
            python daily_pipeline.py --category "$CATEGORY"
          fi

      - name: Save run artifacts (questions + upload log + videos)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k2-quiz-run-${{ github.run_id }}
          path: |
            output/**/questions.json
            output/**/upload_log.json
            output/**/*.mp4
          retention-days: 3
          if-no-files-found: warn
